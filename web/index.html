<html>
  <head>
    <title>LED Draw</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
  </head>
  <body>

    <canvas id="canvas" style="width:80mm; height:80mm; image-rendering:pixelated; margin-bottom: 10px; border:1px solid black;" width="8" height="8"></canvas>

    <form>
      <label for="draw_color">Choose color: </label>
      <input type="color" id="draw_color" value="#FF0000">
    </form>

    <script>
      const draw_topic = 'nitek/draw';
      const connect_topic = 'nitek/draw/connect';
      client = new Paho.MQTT.Client('wss://broker.emqx.io:8084/mqtt', Math.random().toString(36).substring(20));

      var canvas = document.getElementById("canvas");
      var context = canvas.getContext("2d");


      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;

      client.connect({onSuccess:onConnect});


      function onConnect() {
        // Once a connection has been made, make a subscription and send a message.
        console.log("onConnect");
        client.subscribe(draw_topic);

        message = new Paho.MQTT.Message("1");
        message.destinationName = connect_topic;
        client.send(message);
      }

      // called when the client loses its connection
      function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
          console.log("onConnectionLost:"+responseObject.errorMessage);
        }
        // Reconnect
        console.log("Reconnecting");
        client.connect({onSuccess:onConnect});
      }

      // called when a message arrives
      function onMessageArrived(message) {
        console.log("onMessageArrived:"+toHexString(message.payloadBytes));
        var x = message.payloadBytes[0];
        var y = message.payloadBytes[1];

        context.fillStyle = '#' + toHexString(message.payloadBytes.slice(2, 5));
        context.fillRect(x, y, 1, 1);
      }

      function toHexString(byteArray) {
        return Array.from(byteArray, function(byte) {
          return ('0' + (byte & 0xFF).toString(16)).slice(-2);
        }).join('')
      }

      var pixel_width = context.canvas.clientWidth / canvas.width;
      var pixel_height = context.canvas.clientHeight / canvas.height;

      var rect = canvas.getBoundingClientRect();

      //Background
      context.fillStyle = "black";
      context.fillRect(0, 0, canvas.width, canvas.height);

      canvas.addEventListener("click", function(e) {
        var x = Math.floor((e.clientX - rect.left) / pixel_width);
        var y = Math.floor((e.clientY - rect.top) / pixel_height);

        context.fillStyle = document.getElementById("draw_color").value;
        context.fillRect(x, y, 1, 1);
        var payload = new Uint8Array(5);
        payload[0] = x;
        payload[1] = y;
        payload[2] = Number('0x' + context.fillStyle.substr(1, 2)).toString(10);
        payload[3] = Number('0x' + context.fillStyle.substr(3, 2)).toString(10);
        payload[4] = Number('0x' + context.fillStyle.substr(5, 2)).toString(10);
        message = new Paho.MQTT.Message(payload);
        message.destinationName = draw_topic;
        client.send(message);
      }, true);

    </script>
</body>
</html>